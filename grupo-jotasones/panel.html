<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Guardias</title>

<style>
:root{
    --azul:#2563eb;
    --gris:#64748b;
    --fondo:#f8fafc;
    --borde:#e2e8f0;
    --verde:#16a34a;
    --rojo:#dc2626;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}

body{
    background:var(--fondo);
    padding:20px;
}

h1{text-align:center;color:var(--azul)}
h2{text-align:center;color:var(--gris);margin-bottom:14px}

button{
    padding:8px 12px;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
}
.btn-principal{background:var(--azul);color:white}
.btn-secundario{background:#e0e7ff;color:var(--azul)}
.btn-peligro{background:#fee2e2;color:var(--rojo)}

.panel{
    background:white;
    padding:14px;
    border-radius:14px;
    box-shadow:0 6px 16px rgba(0,0,0,.08);
}

.franja{
    display:grid;
    grid-template-columns:1fr 2fr 1fr;
    gap:16px;
    padding:12px;
    border-radius:14px;
    margin-bottom:14px;
}
.franja:nth-child(even){background:#f1f5f9}

.ausencia{
    border:1px solid var(--borde);
    padding:10px;
    border-radius:12px;
    margin-bottom:8px;
}
.cubierta{background:#d1fae5}
.pendiente{background:#fee2e2}

.form-ausencia{
    display:none;
    margin:20px 0;
}

.form-group{margin-bottom:10px}
input,select{
    width:100%;
    padding:8px;
    border-radius:8px;
    border:1px solid var(--borde);
}

#menuTiempos{
    background:white;
    padding:12px;
    border-radius:14px;
    margin:16px 0;
    font-size:13px;
    color:var(--gris);
}

.toast{
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    background:var(--verde);
    color:white;
    padding:12px 20px;
    border-radius:12px;
    box-shadow:0 10px 20px rgba(0,0,0,.2);
    z-index:9999;
}
</style>
</head>

<body>

<h1>Panel de Guardias</h1>
<h2>Fecha: <span id="fechaMostrada"></span></h2>

<div id="menuTiempos">
    <b>Tiempos de carga</b>
    <div id="listaTiempos"></div>
</div>

<button class="btn-principal" onclick="toggleForm()">âž• Registrar ausencia</button>

<!-- FORMULARIO AUSENCIA -->
<div id="formAusencia" class="panel form-ausencia">
    <h3>Registrar ausencia</h3>

    <div class="form-group">
        <label>Profesor</label>
        <select id="profesorAusente"></select>
    </div>

    <div class="form-group">
        <label>Grupo</label>
        <select id="grupoAusente"></select>
    </div>

    <div class="form-group">
        <label>Hora inicio</label>
        <select id="horaInicio"></select>
    </div>

    <div class="form-group">
        <label>Hora fin</label>
        <select id="horaFin"></select>
    </div>

    <div class="form-group">
        <label>Tarea para el alumnado</label>
        <input id="tareaAusencia">
    </div>

    <button class="btn-principal" onclick="crearAusencia()">Guardar ausencia</button>
</div>

<div id="panelHoras"></div>

<script>
const API = location.origin + "/api";
const fecha = new Date().toISOString().split('T')[0];
fechaMostrada.textContent = fecha;

let ultimaHoraCreada = null;
let ausenciaSeleccionada = null;

// ---------- TIEMPOS ----------
function limpiarTiempos(){
    listaTiempos.innerHTML = '';
}

async function medir(nombre, fn){
    const t0 = performance.now();
    await fn();
    const t1 = performance.now();
    listaTiempos.innerHTML += `<div>${nombre}: ${Math.round(t1 - t0)} ms</div>`;
}

// ---------- UTIL ----------
function toast(txt){
    const t=document.createElement('div');
    t.className='toast';
    t.textContent=txt;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),2500);
}

function toggleForm(){
    formAusencia.style.display =
        formAusencia.style.display === 'block' ? 'none' : 'block';
}

// ---------- AUSENCIAS ----------
async function crearAusencia(){
    await medir('Crear ausencia', async ()=>{
        await fetch(API+'/reportes',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                profesor_id:profesorAusente.value,
                grupo_id:grupoAusente.value,
                hora_inicio:horaInicio.value,
                hora_fin:horaFin.value,
                tarea:tareaAusencia.value,
                fecha
            })
        });
    });

    ultimaHoraCreada = horaInicio.value;
    formAusencia.style.display='none';
    toast('âœ… Ausencia registrada');
    cargarPanel();
}

async function borrarAusencia(id){
    if(!confirm('Â¿Seguro que quieres eliminar esta ausencia?')) return;

    await medir('Borrar ausencia', async ()=>{
        await fetch(API+'/reportes/'+id,{method:'DELETE'});
    });

    toast('ðŸ—‘ï¸ Ausencia eliminada');
    cargarPanel();
}

// ---------- GUARDIAS ----------
async function seleccionarAusencia(id,hora){
    ausenciaSeleccionada={id,hora};

    await medir('Cargar disponibles', async ()=>{
        const d = await fetch(
            API+`/profesores-disponibles?hora=${hora}&fecha=${fecha}`
        ).then(r=>r.json());

        document.getElementById('guardia'+hora).innerHTML=`
            <select id="profesorGuardia">
                ${d.map(p=>`<option value="${p.id}">
                    ${p.nombre} ${p.apellidos}
                </option>`).join('')}
            </select>
            <button class="btn-principal" onclick="asignarGuardia()">
                Asignar guardia a la ausencia
            </button>
        `;
    });
}

async function asignarGuardia(){
    await medir('Asignar guardia', async ()=>{
        await fetch(API+'/guardias',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                reporte_id:ausenciaSeleccionada.id,
                profesor_guardia_id:profesorGuardia.value,
                hora:ausenciaSeleccionada.hora,
                fecha
            })
        });
    });

    toast('ðŸ›¡ï¸ Guardia registrada');
    cargarPanel();
}

// ---------- PANEL ----------
async function cargarPanel(){
    limpiarTiempos();

    let data = [];

    await medir('Cargar ausencias', async ()=>{
        data = await fetch(API+`/panel?fecha=${fecha}`).then(r=>r.json());
    });

    panelHoras.innerHTML='';

    for(let h=1;h<=6;h++){
        let disp = [];

        await medir(`Disponibles ${h}Âª`, async ()=>{
            disp = await fetch(
                API+`/profesores-disponibles?hora=${h}&fecha=${fecha}`
            ).then(r=>r.json());
        });

        const aus = data.filter(a=>a.hora_inicio==h);

        panelHoras.innerHTML+=`
        <div class="franja" id="hora${h}">
            <div class="panel">
                <b>${h}Âª hora Â· Disponibles</b><br>
                ${disp.map(p=>`${p.nombre} ${p.apellidos}`).join('<br>')||'â€”'}
            </div>

            <div class="panel">
                <b>${h}Âª hora Â· Ausencias</b><br><br>
                ${aus.map(a=>`
                    <div class="ausencia ${a.nombre_guardia?'cubierta':'pendiente'}">
                        <b>${a.nombre_profesor} ${a.apellidos_profesor}</b><br>
                        <b>Grupo:</b> ${a.grupo}<br>
                        <b>Tarea:</b> ${a.tarea || 'â€”'}<br>
                        ${a.nombre_guardia
                            ? `Cubierta por ${a.nombre_guardia} ${a.apellidos_guardia}`
                            : 'Sin cubrir'
                        }<br>
                        ${!a.nombre_guardia
                            ? `<button class="btn-secundario"
                                onclick="seleccionarAusencia(${a.id},${h})">
                                Asignar guardia a la ausencia
                               </button>`
                            : ''
                        }
                        <button class="btn-peligro"
                            onclick="borrarAusencia(${a.id})">Eliminar</button>
                    </div>
                `).join('')||'â€”'}
            </div>

            <div class="panel" id="guardia${h}">
                <b>${h}Âª hora Â· Guardia</b><br>â€”
            </div>
        </div>`;
    }

    if(ultimaHoraCreada){
        document.getElementById('hora'+ultimaHoraCreada)
            .scrollIntoView({behavior:'smooth'});
        ultimaHoraCreada=null;
    }
}

// ---------- INIT ----------
(async ()=>{
    const profesores = await fetch(API+'/profesores').then(r=>r.json());
    profesorAusente.innerHTML = profesores.map(
        p=>`<option value="${p.id}">${p.nombre} ${p.apellidos}</option>`
    ).join('');

    const grupos = await fetch(API+'/grupos').then(r=>r.json());
    grupoAusente.innerHTML = grupos.map(
        g=>`<option value="${g.id}">${g.nombre}</option>`
    ).join('');

    for(let h=1;h<=6;h++){
        horaInicio.innerHTML+=`<option value="${h}">${h}Âª</option>`;
        horaFin.innerHTML+=`<option value="${h}">${h}Âª</option>`;
    }

    cargarPanel();
})();
</script>

</body>
</html>
